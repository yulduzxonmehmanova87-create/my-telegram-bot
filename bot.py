# bot.py - To'liq ishlaydigan Olimpiada Ro'yxatga Olish Boti# aiogram 3.x versiyasiimport asyncioimport loggingfrom typing import Dict, Anyimport pandas as pdfrom datetime import datetimefrom aiogram import Bot, Dispatcher, typesfrom aiogram.filters import Commandfrom aiogram.fsm.context import FSMContextfrom aiogram.fsm.state import State, StatesGroupfrom aiogram.fsm.storage.memory import MemoryStoragefrom aiogram.utils.keyboard import InlineKeyboardBuilderfrom aiogram.types import Message, CallbackQuery, ReplyKeyboardRemovefrom aiogram.exceptions import TelegramBadRequest# ==================== KONFIGURATSIYA ====================BOT_TOKEN = "8592903771:AAEENoUEwTb_Td9yJ4ptL5NqxGq_yeuKa38"  # O'zgartiring!ADMIN_ID = 928831361  # O'zgartiring!CHANNEL_USERNAME = "@chortoq_tim_it"  # O'zgartiring!EXCEL_FILE = "olympiad_users.xlsx"# ==================== LOGGING SOZLASH ====================logging.basicConfig(    level=logging.INFO,    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s")logger = logging.getLogger(__name__)# ==================== BOT VA DISPATCHER ====================bot = Bot(token=BOT_TOKEN, parse_mode="HTML")storage = MemoryStorage()dp = Dispatcher(storage=storage)# ==================== FSM HOLATLARI ====================class RegistrationForm(StatesGroup):    check_subscription = State()    first_name = State()    last_name = State()    grade = State()    school = State()# ==================== YORDAMCHI FUNKSIYALAR ====================def check_excel_file():    """Excel fayl mavjudligini tekshirish"""    try:        pd.read_excel(EXCEL_FILE)    except FileNotFoundError:        df = pd.DataFrame(columns=["ID", "Ism", "Familiya", "Sinf", "Maktab", "Username", "Ro'yxatdan o'tish vaqti"])        df.to_excel(EXCEL_FILE, index=False)        logger.info(f"{EXCEL_FILE} fayli yaratildi")async def save_to_excel(data: Dict[str, Any], user_id: int, username: str):    """Ma'lumotlarni Excel fayliga saqlash"""    try:        df = pd.read_excel(EXCEL_FILE)                new_row = {            "ID": user_id,            "Ism": data.get("first_name", ""),            "Familiya": data.get("last_name", ""),            "Sinf": data.get("grade", ""),            "Maktab": data.get("school", ""),            "Username": username,            "Ro'yxatdan o'tish vaqti": datetime.now().strftime("%Y-%m-%d %H:%M:%S")        }                df = pd.concat([df, pd.DataFrame([new_row])], ignore_index=True)        df.to_excel(EXCEL_FILE, index=False)        logger.info(f"Foydalanuvchi {user_id} ma'lumotlari saqlandi")        return True    except Exception as e:        logger.error(f"Excel fayliga saqlashda xato: {e}")        return Falseasync def is_subscribed(user_id: int) -> bool:    """Foydalanuvchi kanalga obuna ekanligini tekshirish"""    try:        member = await bot.get_chat_member(chat_id=CHANNEL_USERNAME, user_id=user_id)        return member.status in ["member", "administrator", "creator"]    except TelegramBadRequest:        logger.warning(f"Kanal {CHANNEL_USERNAME} topilmadi yoki bot admin emas")        # Test uchun - haqiqiy botda bu qismni o'chirib qo'ying        return True    except Exception as e:        logger.error(f"Obunani tekshirishda xato: {e}")        return Falsedef create_subscription_keyboard():    """Obuna tekshirish uchun tugmalar yaratish"""    builder = InlineKeyboardBuilder()    builder.add(types.InlineKeyboardButton(        text="ğŸ”” Kanalga o'tish",         url=f"https://t.me/{CHANNEL_USERNAME[1:]}"    ))    builder.add(types.InlineKeyboardButton(        text="âœ… Tekshirish",         callback_data="check_subscription"    ))    return builder.as_markup()# ==================== HANDLERLAR ====================# /start komandasi@dp.message(Command("start"))async def cmd_start(message: Message, state: FSMContext):    user_id = message.from_user.id    username = message.from_user.username or "Yo'q"        logger.info(f"Yangi foydalanuvchi: {user_id} (@{username})")        await state.set_state(RegistrationForm.check_subscription)        await message.answer(        "Assalomu alaykum! Olimpiadaga ro'yxatdan o'tish botiga xush kelibsiz.\n\n"        "Botdan foydalanish uchun avval quyidagi kanalga obuna bo'ling:",        reply_markup=create_subscription_keyboard()    )# Obunani tekshirish tugmasi@dp.callback_query(lambda c: c.data == "check_subscription")async def process_check_subscription(callback_query: CallbackQuery, state: FSMContext):    user_id = callback_query.from_user.id        subscribed = await is_subscribed(user_id)        if subscribed:        await callback_query.answer("âœ… Siz kanalga obuna bo'lgansiz!")        await callback_query.message.delete()                await state.set_state(RegistrationForm.first_name)        await callback_query.message.answer(            "ğŸ‰ Kanalga obuna bo'lgansiz!\n\n"            "Endi olimpiadaga ro'yxatdan o'tishni boshlaymiz.\n\n"            "Iltimos, ismingizni kiriting:"        )    else:        await callback_query.answer("âŒ Siz hali kanalga obuna bo'lmagansiz!", show_alert=True)        await callback_query.message.answer(            "Botdan foydalanish uchun avval kanalga obuna bo'ling:",            reply_markup=create_subscription_keyboard()        )# Ism kiritish@dp.message(RegistrationForm.first_name)async def process_first_name(message: Message, state: FSMContext):    await state.update_data(first_name=message.text)    await state.set_state(RegistrationForm.last_name)    await message.answer("ğŸ‘Œ Ismingiz qabul qilindi!\n\nEndi familiyangizni kiriting:")# Familiya kiritish@dp.message(RegistrationForm.last_name)async def process_last_name(message: Message, state: FSMContext):    await state.update_data(last_name=message.text)    await state.set_state(RegistrationForm.grade)    await message.answer("ğŸ‘Œ Familiyangiz qabul qilindi!\n\nQaysi sinfda o'qiysiz? (Masalan: 2,3,4):")# Sinf kiritish@dp.message(RegistrationForm.grade)async def process_grade(message: Message, state: FSMContext):    await state.update_data(grade=message.text)    await state.set_state(RegistrationForm.school)    await message.answer("ğŸ‘Œ Sinfingiz qabul qilindi!\n\nEndi maktab nomingizni kiriting:")# Maktab nomi kiritish va yakunlash@dp.message(RegistrationForm.school)async def process_school(message: Message, state: FSMContext):    await state.update_data(school=message.text)        user_data = await state.get_data()    user_id = message.from_user.id    username = message.from_user.username or "Yo'q"        success = await save_to_excel(user_data, user_id, username)        if success:        await message.answer(            "ğŸ‰ Tabriklaymiz! Siz muvaffaqiyatli ro'yxatdan o'tdingiz!\n\n"            "Ro'yxatdan o'tgan ma'lumotlaringiz:\n"            f"ğŸ‘¤ Ism: {user_data.get('first_name')}\n"            f"ğŸ“– Familiya: {user_data.get('last_name')}\n"            f"ğŸ« Sinf: {user_data.get('grade')}\n"            f"ğŸ“š Maktab: {user_data.get('school')}\n\n"            "Olimpiada haqida keyingi ma'lumotlar kanal orqali e'lon qilinadi.",            reply_markup=ReplyKeyboardRemove()        )                # Admin ga xabar        try:            admin_message = (                "ğŸ“Š Yangi ro'yxatdan o'tgan foydalanuvchi:\n\n"                f"ğŸ†” ID: {user_id}\n"                f"ğŸ‘¤ Username: @{username}\n"                f"ğŸ‘¨â€ğŸ“ Ism: {user_data.get('first_name')}\n"                f"ğŸ“– Familiya: {user_data.get('last_name')}\n"                f"ğŸ« Sinf: {user_data.get('grade')}\n"                f"ğŸ“š Maktab: {user_data.get('school')}\n"                f"â° Vaqt: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"            )            await bot.send_message(ADMIN_ID, admin_message)        except Exception as e:            logger.error(f"Admin ga xabar yuborishda xato: {e}")    else:        await message.answer(            "âŒ Xatolik yuz berdi. Iltimos, qaytadan urinib ko'ring "            "yoki administrator bilan bog'laning."        )        await state.clear()# ==================== ADMIN KOMANDALARI ====================@dp.message(Command("users"))async def cmd_users(message: Message):    """Admin uchun Excel faylni yuklab olish"""    if message.from_user.id != ADMIN_ID:        await message.answer("âŒ Bu komanda faqat admin uchun!")        return        try:        with open(EXCEL_FILE, "rb") as file:            await message.answer_document(                document=types.BufferedInputFile(                    file.read(),                    filename=EXCEL_FILE                ),                caption=f"ğŸ“Š Jami ro'yxatdan o'tganlar: {len(pd.read_excel(EXCEL_FILE))} ta"            )    except Exception as e:        await message.answer(f"âŒ Faylni yuborishda xato: {e}")        logger.error(f"Faylni yuborishda xato: {e}")@dp.message(Command("stats"))async def cmd_stats(message: Message):    """Admin uchun statistikani ko'rsatish"""    if message.from_user.id != ADMIN_ID:        await message.answer("âŒ Bu komanda faqat admin uchun!")        return        try:        df = pd.read_excel(EXCEL_FILE)                if df.empty:            await message.answer("ğŸ“Š Hozircha ro'yxatdan o'tganlar yo'q")            return                total_users = len(df)        grade_stats = df["Sinf"].value_counts().to_dict()                stats_message = f"ğŸ“Š Ro'yxatdan o'tganlar statistikasi:\n\n"        stats_message += f"ğŸ‘¥ Jami foydalanuvchilar: {total_users} ta\n\n"                if grade_stats:            stats_message += "ğŸ« Sinf bo'yicha taqsimot:\n"            for grade, count in grade_stats.items():                stats_message += f"  {grade}-sinf: {count} ta\n"                await message.answer(stats_message)            except Exception as e:        await message.answer(f"âŒ Statistikani o'qishda xato: {e}")@dp.message(Command("help"))async def cmd_help(message: Message):    """Yordam komandasi"""    help_text = (        "ğŸ¤– Bot buyruqlari:\n\n"        "/start - Botni ishga tushirish\n"        "/help - Yordam olish\n\n"        "Admin buyruqlari:\n"        "/users - Excel faylni yuklab olish\n"        "/stats - Statistikani ko'rish"    )    await message.answer(help_text)# ==================== ASOSIY DASTUR ====================async def main():    """Botni ishga tushirish"""    check_excel_file()    logger.info("Bot ishga tushmoqda...")    await dp.start_polling(bot)if __name__ == "__main__":    try:        asyncio.run(main())    except KeyboardInterrupt:        logger.info("Bot to'xtatildi")    except Exception as e:        logger.error(f"Botda xatolik: {e}")# ==================== QO'LLANMA ===================="""QANDAY QILIB ISHGA TUSHIRISH:1. Avval kerakli kutubxonalarni o'rnating:   pip install aiogram==3.10.0 openpyxl pandas      Yoki aniq versiya bermasdan:   pip install aiogram openpyxl pandas2. Kodni bot.py faylga saqlang3. Quyidagi o'zgartirishlarni amalga oshiring:   - BOT_TOKEN o'rniga o'zingizning bot tokenizni yozing     (Tokenni @BotFather dan olishingiz mumkin)      - ADMIN_ID o'rniga o'zingizning Telegram ID ingizni yozing     (ID ni @userinfobot yordamida bilib olishingiz mumkin)      - CHANNEL_USERNAME o'rniga obuna bo'lish kerak bo'lgan     kanal username'ini yozing (masalan: @mychannel)4. Botni ishga tushiring:   python bot.py5. Botni tekshirish uchun /start komandasini yuboringEslatma: Agar bot kanalda a'zolarni tekshira olmasa,botni kanalga admin qiling."""